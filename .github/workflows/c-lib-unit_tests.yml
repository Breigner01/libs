name: C Lib Unit Tests

on: [push]

WEBHOOK_URL = https://discordapp.com/api/webhooks/701168816582819897/2GX0U3ikm-mEBrpZ2PmEvyS6wSxG5RXDIC6wx2lz3VcyEy_R-hNAsmsaX88bDMCH_CoF

defaults:
  run:
    shell: bash
    working-directory: c-lib


jobs:
  run_unit_tests:
    name: Run Unit Tests
    runs-on: ubuntu-18.04

    steps:
    - uses: actions/checkout@v2
    - name: Install Criterion and Gcovr
      run: |
        sudo add-apt-repository ppa:snaipewastaken/ppa
        sudo apt-get update
        sudo apt-get install criterion-dev gcovr
    - name: Build
      run: make tests_run
    - name: Run
      run: ./unit_test -j1 --verbose
    - uses: actions/setup-ruby@v1
    - name: Send Webhook Notification
      if: always()
      env:
        JOB_STATUS: ${{ job.status }}
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        HOOK_OS_NAME: ${{ runner.os }}
        WORKFLOW_NAME: ${{ github.workflow }}
      run: |
        git clone https://github.com/DiscordHooks/github-actions-discord-webhook.git webhook
        bash webhook/send.sh $JOB_STATUS $WEBHOOK_URL
      shell: bash
